{% extends "base.jinja.html" %}

{% block content %}

<main id='map' style='width: 100%; height: 600px;'></main>
<footer>
  <div>
    <span class="sign very-good"></span>Velmi doporučuji (Excellent!)
  </div>
  <div>
    <span class="sign pretty-good"></span>Doporučuji (Pretty good!)
  </div>
  <div>
    <span class="sign good"></span>Not great, not terrible
  </div>
  <div>
    <span class="sign not-been-yet"></span>Zatím nevyzkoušeno (Not been yet)
  </div>

  <p style="margin: 0; opacity: 0.5; font-size: 0.8rem;">vyrobeno <a href="https://marrrt.in"
      target="_blank">martinem</a></p>
</footer>

<div id="installContainer" class="hidden">
  <button id="butInstall" type="button">Install</button>
</div>

<script>
  mapboxgl.accessToken = 'pk.eyJ1Ijoicm9zZW5iZXJnbSIsImEiOiJjamtzYjlnYnkzcjF3M3Fwanc4Nmdmd3IxIn0.j29iER1BDiwOCUCwk4aA9A';

  const map = new mapboxgl.Map({
    container: 'map',
    // Choose from Mapbox's core styles, or make your own style with Mapbox Studio
    style: 'mapbox://styles/mapbox/streets-v12',
    center: [14.4378, 50.0755], // starting center in [lng, lat]
    zoom: 10 // starting zoom
  });

  map.addControl(
    new mapboxgl.GeolocateControl({
      positionOptions: {
        enableHighAccuracy: true
      },
      // When active the map will receive updates to the device's location as it changes.
      trackUserLocation: true,
      // Draw an arrow next to the location dot to indicate which direction the device is heading.
      showUserHeading: true
    })
  );

  const data = {{ places | tojson | safe }};
  const days = ['pondělí', 'úterý', 'středa', 'čtvrtek', 'pátek', 'sobota', 'neděle']

  for (const point of data) {
    const hours = Object.entries(point.hours ?? []).map(([day, time]) => `<b>${days[day]}</b><span>${time}</span>`)
    hours.push(hours.shift())

    const popup = new mapboxgl.Popup({ offset: 25, maxWidth: '300px' }).setHTML(
      `<h3>${point.name}</h3>
      <div class="images">
        ${point.images.map(i => `<img src="https://db.martinovykavarny.cz/api/files/places/${point.id}/${i}" onerror="this.style.display = 'none'"/>`).join('')}
      </div>
      <p class="hint">scrolluj, je tam víc obrázků;)</p>
      <p>${point.description}</p>
      <p>${point.address}</p>
      <a target="_blank" href="${point.link}">Otevřít v Mapách Google</a>`
      + (point.hours
        ? `<details>
            <summary>Otevírací doba</summary>
            <div class="hours">
              ${hours.join('')}
            </div>
          </details>`
        : '')
    ).addClassName('popup');

    new mapboxgl.Marker({
      color: point.color
    }).setLngLat(point.coordinates).setPopup(popup).addTo(map);
  }

</script>

{% endblock content %}